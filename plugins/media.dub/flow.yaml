id: media.dub
runtime: dsl

steps:
  - id: extract
    op: media.extract_audio
    in:
      project_id: "{{ context.project_id }}"
      src_video: "{{ inputs.video }}"

  - id: asr
    op: media.asr
    in:
      project_id: "{{ context.project_id }}"
      src_audio: "{{ steps.extract.audio }}"
      lang: null
      diarize: false

  - id: translate
    op: media.translate
    in:
      project_id: "{{ context.project_id }}"
      segments: "{{ steps.asr.segments }}"
      target_lang: "{{ inputs.target_lang }}"
      source_lang: "{{ steps.asr.language }}"

  - id: tts
    op: media.tts
    in:
      project_id: "{{ context.project_id }}"
      segments: "{{ steps.translate.segments }}"
      voice: "{{ inputs.voice }}"
      lang: "{{ inputs.target_lang }}"

  - id: mux
    op: media.mux
    in:
      project_id: "{{ context.project_id }}"
      src_video: "{{ inputs.video }}"
      new_audio: "{{ steps.tts.audio }}"

  - id: subs
    op: media.subtitles
    in:
      project_id: "{{ context.project_id }}"
      segments: "{{ steps.translate.segments }}"

outputs:
  dubbed: "{{ steps.mux.video }}"
  srt: "{{ steps.subs.srt }}"
  transcript: "{{ steps.asr }}"
