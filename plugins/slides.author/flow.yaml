{
  "version": 1,
  "vars": {
    "project_id": "{{ inputs.project_id | default(random_id('prj_')) }}",
    "slides_count": "{{ inputs.slides_count | default(5) }}",
    "topic_effective": "{{ inputs.topic or inputs.prompt or 'عرض تقديمي' }}",
    "language_effective": "{{ inputs.language | default('ar') }}",
    "queries": "{{ inputs.images_query_pack | default(['موضوع','أدوات','فوائد','تحديات']) }}"
  },
  "steps": [
    {
      "id": "noop",
      "run": "io.save_text",
      "in": { "to_dir": "tmp", "filename": "noop.txt", "text": "ok" },
      "out": { "path": "@noop" }
    },
    {
      "id": "hello",
      "run": "echo",
      "in": { "text": "أهلاً! سننشئ عرضًا عن {{ vars.topic_effective }} من {{ vars.slides_count }} شرائح…" }
    },

    {
      "id": "outline_branch",
      "run": "switch",
      "when": {
        "inputs.use_research == true": {
          "run": "sequence",
          "do": [
            {
              "id": "research_pipeline",
              "run": "research.pipeline",
              "in": {
                "project_id": "{{ vars.project_id }}",
                "topic": "{{ vars.topic_effective }}",
                "urls": "{{ inputs.urls }}",
                "language": "{{ vars.language_effective }}",
                "max_docs": 8
              },
              "out": {
                "outline": "@outline",
                "citations": "@citations"
              }
            }
          ]
        },
        "inputs.source == 'docx'": {
          "run": "sequence",
          "do": [
            {
              "id": "fetch_docx",
              "run": "io.fetch",
              "in": { "url": "{{ inputs.docx_url }}", "to_dir": "input" },
              "out": { "path": "@docx_path" }
            },
            {
              "id": "parse_docx",
              "run": "doc.parse_docx",
              "in": { "path": "@docx_path" },
              "out": { "text": "@doc_text" }
            },
            {
              "id": "outline_from_doc",
              "run": "slides.outline.from_doc",
              "in": {
                "text": "@doc_text",
                "language": "{{ vars.language_effective }}",
                "count": "{{ vars.slides_count }}"
              },
              "out": { "outline": "@outline" }
            }
          ]
        },
        "true": {
          "run": "slides.outline.from_prompt_stub",
          "in": {
            "topic": "{{ vars.topic_effective }}",
            "language": "{{ vars.language_effective }}",
            "count": "{{ vars.slides_count }}"
          },
          "out": { "outline": "@outline" }
        }
      }
    },

    {
      "id": "images",
      "run": "vision.images.from_fixtures",
      "in": {
        "project_id": "{{ vars.project_id }}",
        "queries": "{{ vars.queries }}"
      },
      "out": { "images": "@images" }
    },

    {
      "id": "render",
      "run": "slides.html.render",
      "needs": ["outline_branch", "images"],
      "in": {
        "project_id": "{{ vars.project_id }}",
        "outline": "@outline",
        "language": "{{ vars.language_effective }}",
        "theme": "{{ inputs.theme | default('academic-ar') }}",
        "images": "@images"
      },
      "out": {
        "state_url": "@state_url",
        "slides_html": "@slides_html"
      }
    },

    {
      "id": "apply_citations",
      "run": "slides.citations.apply",
      "needs": ["render"],
      "in": {
        "project_id": "{{ vars.project_id }}",
        "outline": "@outline",
        "language": "{{ vars.language_effective }}",
        "citations": "@citations"
      },
      "out": { "updated": "@citation_updates" }
    },

    {
      "id": "index_link",
      "run": "slides.index.render",
      "needs": ["render", "apply_citations"],
      "in": { "project_id": "{{ vars.project_id }}" },
      "out": { "url": "@index_url", "path": "@index_path" }
    },

    {
      "id": "build_pptx",
      "run": "slides.pptx.build",
      "needs": ["render"],
      "in": {
        "project_id": "{{ vars.project_id }}",
        "outline": "@outline",
        "title": "{{ (@outline and @outline[0]['title']) or vars.topic_effective }}",
        "language": "{{ vars.language_effective }}"
      },
      "out": { "pptx_url": "@pptx_url", "pptx_path": "@pptx_path" }
    },

    {
      "id": "export_pdf",
      "when": "{{ inputs.export and ('pdf' in inputs.export) }}",
      "run": "slides.export.pdf_via_lo",
      "needs": ["build_pptx"],
      "in": { "project_id": "{{ vars.project_id }}", "pptx_path": "@pptx_path" },
      "out": { "pdf_url": "@pdf_url" }
    },

    {
      "id": "export_html",
      "when": "{{ inputs.export and ('html' in inputs.export) }}",
      "run": "slides.export.html_via_lo",
      "needs": ["build_pptx"],
      "in": { "project_id": "{{ vars.project_id }}", "pptx_path": "@pptx_path" },
      "out": { "html_zip_url": "@html_zip_url" }
    }
  ],

  "outputs": {
    "project_id": "{{ vars.project_id }}",
    "state_url": "@state_url",
    "slides_html": "@slides_html",
    "index_url": "@index_url",
    "pdf_url": "@pdf_url",
    "pptx_url": "@pptx_url",
    "html_zip_url": "@html_zip_url"
  }
}
